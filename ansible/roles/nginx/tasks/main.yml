---

- name: NGINX | Install NGINX
  apt: pkg=nginx state=latest

- name: NGINX | Copy NGINX conf file to sites-available
  template: src=templates/metax_nginx.conf dest=/etc/nginx/sites-available/metax

- name: NGINX | Symlink NGINX conf file to sites-enabled
  file: state=link src=/etc/nginx/sites-available/metax dest=/etc/nginx/sites-enabled/metax

- name: NGINX | Remove default NGINX config file
  file: path=/etc/nginx/sites-enabled/default state=absent

- name: NGINX | Create directory for ssl certificates
  file: path=/etc/nginx/ssl_certs state=directory

- name: NGINX | Generate Diffie-Hellman PFS (Perfect Forward Secrecy) group (this is going to take a while)
  command: openssl dhparam -out /etc/nginx/ssl_certs/dhparam.pem 2048 creates=/etc/nginx/ssl_certs/dhparam.pem

# todo certs for other envs

- name: NGINX | Create self-signed SSL cert
  command: openssl req -x509 -nodes -subj "/C=FI/ST=Espoo/L=Uusimaa/O=REDS/CN={{ server_domain_name }}" -days 365 -newkey rsa:2048 -keyout /etc/nginx/ssl_certs/nginx-selfsigned.key -out /etc/nginx/ssl_certs/nginx-selfsigned.crt creates=/etc/nginx/ssl_certs/nginx-selfsigned.crt
  when: deployment_environment_id == 'local_development' or deployment_environment_id == 'playground'

- name: NGINX | Restart NGINX
  service: name=nginx enabled=yes state=restarted
